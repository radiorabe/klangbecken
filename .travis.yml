os: linux
dist: bionic
language: python
python:
  - "3.6"
  - "3.7"
  - "3.8"
addons:
  apt:
    packages:
      - ffmpeg
env:
  global:
    - KLANGBECKEN_DATA=/tmp/data
before_install:
  - python --version
  - pip install -U pip
install:
  - pip install -r requirements-dev.txt
  - pip install -e .
script:
  - pre-commit run -a
  - klangbecken init -d $KLANGBECKEN_DATA
  - coverage run --source=klangbecken -m unittest discover
  - flake8

# define liquidsoap anchor
_liquidsoap: &liquidsoap
  language: shell
  services: docker
  addons: 
    apt:
      packages:
  before_install: skip
  install: skip
  before_script:
    - docker pull radiorabe/liquidsoap:alpine-$LS_VERSION
  script:
    - docker run --rm -ti radiorabe/liquidsoap:alpine-$LS_VERSION --version
    - mkdir $KLANGBECKEN_DATA
    - touch $KLANGBECKEN_DATA/prio.m3u $KLANGBECKEN_DATA/music.m3u $KLANGBECKEN_DATA/classics.m3u $KLANGBECKEN_DATA/jingles.m3u $KLANGBECKEN_DATA/index.json
    - docker run --rm -ti -e KLANGBECKEN_DATA=$KLANGBECKEN_DATA -v $KLANGBECKEN_DATA:$KLANGBECKEN_DATA -v `pwd`:/var/lib/liquidsoap radiorabe/liquidsoap:alpine-$LS_VERSION --check /var/lib/liquidsoap/klangbecken.liq
  after_script: skip
  after_success: skip
  after_failure: skip

jobs:
  include:
    - <<: *liquidsoap
      name: Liquidsoap 1.3.2
      env: LS_VERSION=1.3.2
    - <<: *liquidsoap
      name: Liquidsoap 1.3.7
      env: LS_VERSION=1.3.7
